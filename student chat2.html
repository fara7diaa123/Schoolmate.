<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØµÙØ­Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</title>
  <style>
    body {
      font-family: "Tahoma", sans-serif;
      background-color: #C8BBBE;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: white;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      color: #333;
      border-bottom: 2px solid #aaa;
    }

    .container {
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      height: 80vh;
    }

    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f9f9f9;
    }

    .message {
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 10px;
      max-width: 70%;
      position: relative;
      font-size: 14px;
      word-wrap: break-word;
    }

    .mine {
      background: #DCF8C6;
      margin-left: auto;
    }

    .other {
      background: #eee;
      margin-right: auto;
    }

    .message .author {
      font-size: 12px;
      color: #555;
      margin-bottom: 3px;
      display: block;
    }

    .time {
      font-size: 11px;
      color: #777;
      display: block;
      margin-top: 4px;
    }

    .actions {
      font-size: 12px;
      color: blue;
      cursor: pointer;
      margin-top: 3px;
    }

    .input-area {
      display: flex;
      border-top: 1px solid #ccc;
    }

    select, input {
      padding: 10px;
      border: none;
      outline: none;
      font-size: 14px;
    }

    select {
      background: #eee;
    }

    #messageInput {
      flex: 1;
    }

    button {
      background: #333;
      color: #fff;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
    }

    button:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <header> ØµÙØ­Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ </header>

  <div class="container">
    <div id="messages"></div>

    <div class="input-area">
      <select id="username">
        <option disabled selected>Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ</option>
        <option>Ø¬Ù†Ù‰</option>
        <option>Ø³ÙŠÙ</option>
        <option>Ø§Ø­Ù…Ø¯</option>
        <option>Ø³Ø§Ø±Ø©</option>
      </select>
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
      <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, remove, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // ğŸ”¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
    const firebaseConfig = {
      apiKey: "AIzaSyBoqPEnCjtYPbWI9yYXg9eBdrPk5KvSHOg",
      authDomain: "schoolmate-d49cd.firebaseapp.com",
      databaseURL: "https://schoolmate-d49cd-default-rtdb.firebaseio.com",
      projectId: "schoolmate-d49cd",
      storageBucket: "schoolmate-d49cd.appspot.com",
      messagingSenderId: "394386208739",
      appId: "1:394386208739:web:211725ccb837298cab92d6",
      measurementId: "G-64K767NCG3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "class2/messages"); // âœ… Ù‡Ù†Ø§ ØºÙŠØ±Ù†Ø§ Ù…Ù† class1 Ù„Ù€ class2

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("messageInput");
    let currentUser = "";

    // ğŸ”¹ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    document.getElementById("username").addEventListener("change", e => {
      currentUser = e.target.value;
      Array.from(messagesDiv.children).forEach(msg => {
        const author = msg.getAttribute("data-author");
        updateActions(msg, author);
      });
    });

    // ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    window.sendMessage = function () {
      if (!currentUser) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ");
        return;
      }
      const text = input.value;
      if (text.trim() === "") return;

      push(messagesRef, {
        author: currentUser,
        text: text,
        timestamp: Date.now()
      });

      input.value = "";
    }

    // ğŸ”¹ Ø¥Ù†ØªØ± ÙŠØ±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    // ğŸ”¹ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¬Ù…ÙŠÙ„
    function formatTime(ms) {
      const d = new Date(ms);
      const date = d.toLocaleDateString("ar-EG");
      const time = d.toLocaleTimeString("ar-EG", { hour: "2-digit", minute: "2-digit" });
      return `${date} - ${time}`;
    }

    // ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    function renderMessage(key, data) {
      let div = document.getElementById(key);
      if (!div) {
        div = document.createElement("div");
        div.classList.add("message");
        div.id = key;
        div.setAttribute("data-author", data.author);
        messagesDiv.appendChild(div);
      }

      div.innerHTML = `
        <span class="author">${data.author}</span>
        <span class="text">${data.text}</span>
        <span class="time">
          ${formatTime(data.timestamp)} 
          ${data.editedAt ? `(ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ${formatTime(data.editedAt)})` : ""}
        </span>
      `;

      updateActions(div, data.author);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // ğŸ”¹ ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ£Ø²Ø±Ø§Ø±Ù‡Ø§
    function updateActions(div, author) {
      div.classList.remove("mine", "other"); 
      const actions = div.querySelector(".actions");
      if (actions) actions.remove();

      if (author === currentUser) {
        div.classList.add("mine");
        const actionsDiv = document.createElement("div");
        actionsDiv.classList.add("actions");
        actionsDiv.innerHTML = `
          <span onclick="editMessage('${div.id}', \`${div.querySelector(".text").innerText}\`)">âœï¸ ØªØ¹Ø¯ÙŠÙ„</span> |
          <span onclick="deleteMessage('${div.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</span>
        `;
        div.appendChild(actionsDiv);
      } else {
        div.classList.add("other");
      }
    }

    // Firebase Events
    onChildAdded(messagesRef, (snapshot) => {
      renderMessage(snapshot.key, snapshot.val());
    });

    onChildChanged(messagesRef, (snapshot) => {
      renderMessage(snapshot.key, snapshot.val());
    });

    onChildRemoved(messagesRef, (snapshot) => {
      const div = document.getElementById(snapshot.key);
      if (div) div.remove();
    });

    // Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø©
    window.deleteMessage = function(key) {
      remove(ref(db, "class2/messages/" + key)); // âœ… Ø¨Ø±Ø¶Ù‡ Ø¹Ø¯Ù„Ù†Ø§ Ù‡Ù†Ø§
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø©
    window.editMessage = function(key, oldText) {
      const newText = prompt("Ø¹Ø¯Ù„ Ø±Ø³Ø§Ù„ØªÙƒ:", oldText);
      if (newText && newText.trim() !== "") {
        update(ref(db, "class2/messages/" + key), { // âœ… ÙˆØ¹Ø¯Ù„Ù†Ø§ Ù‡Ù†Ø§ ÙƒÙ…Ø§Ù†
          text: newText,
          editedAt: Date.now()
        });
      }
    }
  </script>
</body>
</html>
