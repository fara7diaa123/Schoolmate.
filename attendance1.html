<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>الغياب والحضور – SchoolMate</title>
</head>
<body bgcolor="#C8BBBE">
  <h1 align="center">الغياب والحضور</h1>
  <p align="center">سجل حضور الطلاب يوميًا بسهولة</p>
  <hr color="white" size="3">

  <div align="center">
    <button onclick="clearData()"> حذف جميع البيانات</button>
  </div>
  <br>

  <table border="1" width="90%" align="center" cellpadding="3" bgcolor="#DEB887" id="attendanceTable">
    <tr>
      <th>الاسم</th>
    </tr>
    <tr><td>عمار</td></tr>
    <tr><td>غزل</td></tr>
    <tr><td>سالمين</td></tr>
    <tr><td>محمد</td></tr>
  </table>

  <br>
  <p style="cursor:pointer; color:blue;" onclick="window.location.href='index.html'"> الرجوع للصفحة الرئيسية</p>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoqPEnCjtYPbWI9yYXg9eBdrPk5KvSHOg",
      authDomain: "schoolmate-d49cd.firebaseapp.com",
      databaseURL: "https://schoolmate-d49cd-default-rtdb.firebaseio.com",
      projectId: "schoolmate-d49cd",
      storageBucket: "schoolmate-d49cd.firebasestorage.app",
      messagingSenderId: "394386208739",
      appId: "1:394386208739:web:211725ccb837298cab92d6",
      measurementId: "G-64K767NCG3"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const days = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];

    window.addEventListener("load", () => {
      const table = document.getElementById("attendanceTable");
      const startDate = new Date(2025, 9, 12); 
      const totalDays = 14;

      const headerRow = table.rows[0];
      for (let i = 0; i < totalDays; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const th = document.createElement("th");
        th.innerText = days[date.getDay()] + " " + date.toLocaleDateString("ar-EG");
        th.bgColor = "#C58917";
        headerRow.appendChild(th);
      }

      for (let r = 1; r < table.rows.length; r++) {
        const studentName = table.rows[r].cells[0].innerText.trim();
        for (let c = 0; c < totalDays; c++) {
          const cell = document.createElement("td");
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + c);
          const dayIndex = date.getDay();

          if (dayIndex === 5 || dayIndex === 6) { 
            cell.innerText = "إجازة";
            cell.bgColor = "#EBDDE2";
            cell.style.fontSize = "10px";
          } else {
            addAttendanceButtons(cell, studentName, c);
            const saved = localStorage.getItem(`${studentName}_${c}`);
            if (saved === "حضور" || saved === "غياب") {
              updateCell(cell, saved, studentName, c);
            }
          }
          table.rows[r].appendChild(cell);
        }
      }

      function addAttendanceButtons(cell, student, day) {
        cell.innerHTML = "";
        cell.style.backgroundColor = "";
        const presentBtn = document.createElement("button");
        presentBtn.innerText = "✔";
        presentBtn.onclick = () => markAttendance(student, day, "حضور", cell);
        const absentBtn = document.createElement("button");
        absentBtn.innerText = "✘";
        absentBtn.onclick = () => markAttendance(student, day, "غياب", cell);
        cell.appendChild(presentBtn);
        cell.appendChild(absentBtn);
      }

      function updateCell(cell, status, student, day) {
        cell.style.backgroundColor = (status === "حضور") ? "#4CAF50" : "#F44336";
        const label = (status === "حضور") ? "✔ حضور" : "✘ غياب";
        const editBtnHTML =
          ` <button style="background-color:#E6D3C6; border:none; cursor:pointer; padding:2px 8px; border-radius:6px;"
             onclick="editAttendance('${student}', ${day}, this)">✎ تعديل</button>`;
        cell.innerHTML = label + editBtnHTML;
      }

      window.markAttendance = (student, day, status, cell) => {
        if (day > 0) {
          const prev = localStorage.getItem(`${student}_${day - 1}`);
          if (!prev) {
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + day);
            alert("لا يمكنك تسجيل يوم " + days[d.getDay()] + " قبل تسجيل اليوم السابق!");
            return;
          }
        }
        updateCell(cell, status, student, day);
        localStorage.setItem(`${student}_${day}`, status);

        set(ref(db, `attendance/الصف_الأول/${student}/${day}`), { status }).catch(console.error);
      };

      window.editAttendance = (student, day, btn) => {
        const cell = btn.parentElement;
        cell.style.backgroundColor = "#DEB887"; 
        addAttendanceButtons(cell, student, day);
        localStorage.removeItem(`${student}_${day}`);
      };

      window.clearData = () => {
        if (confirm("هل أنت متأكد أنك تريد حذف جميع البيانات؟")) {
          localStorage.clear();

          remove(ref(db, "attendance/الصف_الأول"))
            .then(() => {
              alert("تم حذف جميع البيانات  ");
              location.reload();
            })
            .catch(console.error);
        }
      };
    });
  </script>
</body>
</html>

