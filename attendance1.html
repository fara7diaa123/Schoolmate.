<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>ุงูุบูุงุจ ูุงูุญุถูุฑ โ SchoolMate</title>
</head>
<body bgcolor="#C8BBBE">
  <h1 align="center">ุงูุบูุงุจ ูุงูุญุถูุฑ</h1>
  <p align="center">ุณุฌู ุญุถูุฑ ุงูุทูุงุจ ูููููุง ุจุณูููุฉ</p>
  <hr color="white" size="3">

  <div align="center">
    <button onclick="clearData()"> ุญุฐู ุฌููุน ุงูุจูุงูุงุช</button>
  </div>
  <br>

  <table border="1" width="90%" align="center" cellpadding="3" bgcolor="#DEB887" id="attendanceTable">
    <tr>
      <th>ุงูุงุณู</th>
    </tr>
    <tr><td>ุนูุงุฑ</td></tr>
    <tr><td>ุบุฒู</td></tr>
    <tr><td>ุณุงูููู</td></tr>
    <tr><td>ูุญูุฏ</td></tr>
  </table>

  <br>
  <p style="cursor:pointer; color:blue;" onclick="window.location.href='index.html'"> ุงูุฑุฌูุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ</p>

  <!-- ุงูุฌุงูุงุณูุฑูุจุช -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ๐ ุจูุงูุงุช Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBoqPEnCjtYPbWI9yYXg9eBdrPk5KvSHOg",
      authDomain: "schoolmate-d49cd.firebaseapp.com",
      databaseURL: "https://schoolmate-d49cd-default-rtdb.firebaseio.com",
      projectId: "schoolmate-d49cd",
      storageBucket: "schoolmate-d49cd.firebasestorage.app",
      messagingSenderId: "394386208739",
      appId: "1:394386208739:web:211725ccb837298cab92d6",
      measurementId: "G-64K767NCG3"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const days = ["ุงูุฃุญุฏ","ุงูุฅุซููู","ุงูุซูุงุซุงุก","ุงูุฃุฑุจุนุงุก","ุงูุฎููุณ","ุงูุฌูุนุฉ","ุงูุณุจุช"];

    window.addEventListener("load", () => {
      const table = document.getElementById("attendanceTable");
      const startDate = new Date(2025, 9, 12); // 9 = ุฃูุชูุจุฑ
      const totalDays = 14;

      // ุฅูุดุงุก ุงูุฃุนูุฏุฉ (ุงูุชุงุฑูุฎ + ุงูููู)
      const headerRow = table.rows[0];
      for (let i = 0; i < totalDays; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const th = document.createElement("th");
        th.innerText = days[date.getDay()] + " " + date.toLocaleDateString("ar-EG");
        th.bgColor = "#C58917";
        headerRow.appendChild(th);
      }

      // ุฅูุดุงุก ุงูุตููู
      for (let r = 1; r < table.rows.length; r++) {
        const studentName = table.rows[r].cells[0].innerText.trim();
        for (let c = 0; c < totalDays; c++) {
          const cell = document.createElement("td");
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + c);
          const dayIndex = date.getDay();

          if (dayIndex === 5 || dayIndex === 6) { 
            cell.innerText = "ุฅุฌุงุฒุฉ";
            cell.bgColor = "#EBDDE2";
            cell.style.fontSize = "10px";
          } else {
            addAttendanceButtons(cell, studentName, c);
            const saved = localStorage.getItem(`${studentName}_${c}`);
            if (saved === "ุญุถูุฑ" || saved === "ุบูุงุจ") {
              updateCell(cell, saved, studentName, c);
            }
          }
          table.rows[r].appendChild(cell);
        }
      }

      function addAttendanceButtons(cell, student, day) {
        cell.innerHTML = "";
        cell.style.backgroundColor = "";
        const presentBtn = document.createElement("button");
        presentBtn.innerText = "โ";
        presentBtn.onclick = () => markAttendance(student, day, "ุญุถูุฑ", cell);
        const absentBtn = document.createElement("button");
        absentBtn.innerText = "โ";
        absentBtn.onclick = () => markAttendance(student, day, "ุบูุงุจ", cell);
        cell.appendChild(presentBtn);
        cell.appendChild(absentBtn);
      }

      function updateCell(cell, status, student, day) {
        cell.style.backgroundColor = (status === "ุญุถูุฑ") ? "#4CAF50" : "#F44336";
        const label = (status === "ุญุถูุฑ") ? "โ ุญุถูุฑ" : "โ ุบูุงุจ";
        const editBtnHTML =
          ` <button style="background-color:#E6D3C6; border:none; cursor:pointer; padding:2px 8px; border-radius:6px;"
             onclick="editAttendance('${student}', ${day}, this)">โ ุชุนุฏูู</button>`;
        cell.innerHTML = label + editBtnHTML;
      }

      window.markAttendance = (student, day, status, cell) => {
        if (day > 0) {
          const prev = localStorage.getItem(`${student}_${day - 1}`);
          if (!prev) {
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + day);
            alert("ูุง ููููู ุชุณุฌูู ููู " + days[d.getDay()] + " ูุจู ุชุณุฌูู ุงูููู ุงูุณุงุจู!");
            return;
          }
        }
        updateCell(cell, status, student, day);
        localStorage.setItem(`${student}_${day}`, status);

        // โ ุญูุธ ุงูุจูุงูุงุช ูู Firebase ุชุญุช ูุณุงุฑ "ุงูุตู_ุงูุฃูู"
        set(ref(db, `attendance/ุงูุตู_ุงูุฃูู/${student}/${day}`), { status }).catch(console.error);
      };

      window.editAttendance = (student, day, btn) => {
        const cell = btn.parentElement;
        cell.style.backgroundColor = "#DEB887"; 
        addAttendanceButtons(cell, student, day);
        localStorage.removeItem(`${student}_${day}`);
      };

      window.clearData = () => {
        if (confirm("ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุญุฐู ุฌููุน ุงูุจูุงูุงุชุ")) {
          localStorage.clear();

          // ๐ ุญุฐู ูู ุจูุงูุงุช "ุงูุตู ุงูุฃูู" ูู Firebase
          remove(ref(db, "attendance/ุงูุตู_ุงูุฃูู"))
            .then(() => {
              alert("ุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช  ");
              location.reload();
            })
            .catch(console.error);
        }
      };
    });
  </script>
</body>
</html>
