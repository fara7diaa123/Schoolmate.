<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„Ø­Ø¶ÙˆØ± â€“ SchoolMate</title>
</head>
<body bgcolor="#C8BBBE">
  <h1 align="center">Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„Ø­Ø¶ÙˆØ±</h1>
  <p align="center">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨ ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
  <hr color="white" size="3">

  <div align="center">
    <button onclick="clearData()"> Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  </div>
  <br>

  <table border="1" width="90%" align="center" cellpadding="3" bgcolor="#DEB887" id="attendanceTable">
    <tr>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
    </tr>
    <tr><td>Ø¬Ù†Ù‰</td></tr>
    <tr><td>Ø³ÙŠÙ</td></tr>
    <tr><td>Ø§Ø­Ù…Ø¯</td></tr>
    <tr><td>Ø³Ø§Ø±Ø©</td></tr>
  </table>

  <br>
  <p style="cursor:pointer; color:blue;" onclick="window.location.href='index.html'"> Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p>

  <!-- Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ğŸ”‘ Ø¨ÙŠØ§Ù†Ø§Øª Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBoqPEnCjtYPbWI9yYXg9eBdrPk5KvSHOg",
      authDomain: "schoolmate-d49cd.firebaseapp.com",
      databaseURL: "https://schoolmate-d49cd-default-rtdb.firebaseio.com",
      projectId: "schoolmate-d49cd",
      storageBucket: "schoolmate-d49cd.firebasestorage.app",
      messagingSenderId: "394386208739",
      appId: "1:394386208739:web:211725ccb837298cab92d6",
      measurementId: "G-64K767NCG3"
    };

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const days = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];

    window.addEventListener("load", () => {
      const table = document.getElementById("attendanceTable");
      const startDate = new Date(2025, 9, 12); // 9 = Ø£ÙƒØªÙˆØ¨Ø±
      const totalDays = 14;

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„ØªØ§Ø±ÙŠØ® + Ø§Ù„ÙŠÙˆÙ…)
      const headerRow = table.rows[0];
      for (let i = 0; i < totalDays; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const th = document.createElement("th");
        th.innerText = days[date.getDay()] + " " + date.toLocaleDateString("ar-EG");
        th.bgColor = "#C58917";
        headerRow.appendChild(th);
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙÙˆÙ
      for (let r = 1; r < table.rows.length; r++) {
        const studentName = table.rows[r].cells[0].innerText.trim();
        for (let c = 0; c < totalDays; c++) {
          const cell = document.createElement("td");
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + c);
          const dayIndex = date.getDay();

          if (dayIndex === 5 || dayIndex === 6) { 
            cell.innerText = "Ø¥Ø¬Ø§Ø²Ø©";
            cell.bgColor = "#EBDDE2";
            cell.style.fontSize = "10px";
          } else {
            addAttendanceButtons(cell, studentName, c);
            const saved = localStorage.getItem(`${studentName}_${c}`);
            if (saved === "Ø­Ø¶ÙˆØ±" || saved === "ØºÙŠØ§Ø¨") {
              updateCell(cell, saved, studentName, c);
            }
          }
          table.rows[r].appendChild(cell);
        }
      }

      function addAttendanceButtons(cell, student, day) {
        cell.innerHTML = "";
        cell.style.backgroundColor = "";
        const presentBtn = document.createElement("button");
        presentBtn.innerText = "âœ”";
        presentBtn.onclick = () => markAttendance(student, day, "Ø­Ø¶ÙˆØ±", cell);
        const absentBtn = document.createElement("button");
        absentBtn.innerText = "âœ˜";
        absentBtn.onclick = () => markAttendance(student, day, "ØºÙŠØ§Ø¨", cell);
        cell.appendChild(presentBtn);
        cell.appendChild(absentBtn);
      }

      function updateCell(cell, status, student, day) {
        cell.style.backgroundColor = (status === "Ø­Ø¶ÙˆØ±") ? "#4CAF50" : "#F44336";
        const label = (status === "Ø­Ø¶ÙˆØ±") ? "âœ” Ø­Ø¶ÙˆØ±" : "âœ˜ ØºÙŠØ§Ø¨";
        const editBtnHTML =
          ` <button style="background-color:#E6D3C6; border:none; cursor:pointer; padding:2px 8px; border-radius:6px;"
             onclick="editAttendance('${student}', ${day}, this)">âœ ØªØ¹Ø¯ÙŠÙ„</button>`;
        cell.innerHTML = label + editBtnHTML;
      }

      window.markAttendance = (student, day, status, cell) => {
        if (day > 0) {
          const prev = localStorage.getItem(`${student}_${day - 1}`);
          if (!prev) {
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + day);
            alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ ÙŠÙˆÙ… " + days[d.getDay()] + " Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚!");
            return;
          }
        }
        updateCell(cell, status, student, day);
        localStorage.setItem(`${student}_${day}`, status);

        // âœ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase ØªØ­Øª Ù…Ø³Ø§Ø± "Ø§Ù„ØµÙ_Ø§Ù„Ø£ÙˆÙ„"
        set(ref(db, `attendance/Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ/${student}/${day}`), { status }).catch(console.error);
      };

      window.editAttendance = (student, day, btn) => {
        const cell = btn.parentElement;
        cell.style.backgroundColor = "#DEB887"; 
        addAttendanceButtons(cell, student, day);
        localStorage.removeItem(`${student}_${day}`);
      };

      window.clearData = () => {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) {
          localStorage.clear();

          // ğŸ—‘ Ø­Ø°Ù ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„" Ù…Ù† Firebase
          remove(ref(db, "attendance/Ø§Ù„ØµÙ_Ø§Ù„Ø£ÙˆÙ„"))
            .then(() => {
              alert("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª  ");
              location.reload();
            })
            .catch(console.error);
        }
      };
    });
  </script>
</body>
</html>
