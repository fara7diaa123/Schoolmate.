<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>صفحة التواصل (المعلم)</title>
  <style>
    body {
      font-family: "Tahoma", sans-serif;
      background-color: #C8BBBE;
      margin: 0;
      padding: 0;
    }

    header.site-header {
      text-align: center;
      background:#5D4037;
      color:#fff;
      padding:10px 0;
    }
    header.site-header h1 { margin:0; font-size:24px; }

    .tagline {
      text-align:center;
      background:#5D4037;
      color:#fff;
      padding:6px;
      font-size:14px;
      margin:0;
    }

    #navbar {
      background:#8D6E63;
      padding:8px;
      display:flex;
      align-items:center;
      gap:15px;
    }
    #navbar label { color:#fff; font-size:14px; }
    #navbar select { padding:4px 6px; border-radius:4px; }
    #navbar ul { list-style:none; margin:0; padding:0; display:flex; flex:1; justify-content:center; }
    #navbar > ul > li { position:relative; margin:0 10px; }
    #navbar > ul > li > a { color:white; text-decoration:none; padding:6px 8px; display:inline-block; cursor:pointer; font-size:15px; }
    .submenu { display:none !important; position:absolute; top:32px; right:0; background:#fff; padding:5px; border-radius:6px; box-shadow:0 3px 8px rgba(0,0,0,0.15); min-width:140px; z-index:100; }
    .submenu li { margin:4px 0; }
    .submenu a { color:#333; text-decoration:none; display:block; padding:6px 8px; font-size:14px; border-radius:4px; }
    .submenu a:hover { background:#eee; }
    .submenu.open { display:block !important; }

    header.chat-header {
      background-color: #C8BBBE;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      color: #333;
      border-bottom: 2px solid white; 
      margin-top: 10px;
    }

    .container {
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      height: 80vh;
    }

    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f9f9f9;
    }

    .message { padding: 8px 12px; margin: 5px 0; border-radius: 10px; max-width: 70%; position: relative; font-size: 14px; word-wrap: break-word; }
    .mine { background: #cce5ff; margin-left: auto; }
    .other { background: #eee; margin-right: auto; }
    .message .author { font-size: 12px; color: #555; margin-bottom: 3px; display: block; }
    .time { font-size: 11px; color: #777; display: block; margin-top: 4px; }
    .actions { font-size: 12px; color: blue; cursor: pointer; margin-top: 3px; }
    .input-area { display: flex; border-top: 1px solid #ccc; }
    #messageInput { flex: 1; padding: 10px; border: none; outline: none; font-size: 14px; }
    button { background: #333; color: #fff; border: none; padding: 10px 15px; cursor: pointer; }
    button:hover { background: #555; }
  </style>
</head>
<body>

  <header class="site-header">
    <h1>SchoolMate - كشكولك الرقمي</h1>
  </header>
  <p class="tagline">كشكولك الرقمي لمتابعة الغياب، تسجيل الواجبات، والتقارير اليومية</p>

  <div id="navbar">
    <label for="roleSelect">اختر الدور:</label>
    <select id="roleSelect">
      <option value="student">طالب</option>
      <option value="teacher">معلم</option>
    </select>

    <ul id="studentMenu">
      <li><a href="#" class="top-link">الغياب والحضور</a>
        <ul class="submenu">
          <li><a href="student attendance1.html">الصف الأول الثانوي</a></li>
          <li><a href="student attendance2.html">الصف الثاني الثانوي</a></li>
        </ul>
      </li>
      <li><a href="#" class="top-link">الدرجات</a>
        <ul class="submenu">
          <li><a href="student grades1.html">الصف الأول الثانوي</a></li>
          <li><a href="student grades2.html">الصف الثاني الثانوي</a></li>
        </ul>
      </li>
      <li><a href="#" class="top-link">التواصل</a>
        <ul class="submenu">
          <li><a href="student chat1.html">الصف الأول الثانوي</a></li>
          <li><a href="student chat2.html">الصف الثاني الثانوي</a></li>
        </ul>
      </li>
    </ul>

    <ul id="teacherMenu" style="display:none;">
      <li><a href="#" class="top-link">الغياب والحضور</a>
        <ul class="submenu">
          <li><a href="attendance1.html">الصف الأول الثانوي</a></li>
          <li><a href="attendance2.html">الصف الثاني الثانوي</a></li>
        </ul>
      </li>
      <li><a href="#" class="top-link">الدرجات</a>
        <ul class="submenu">
          <li><a href="grades1.html">الصف الأول الثانوي</a></li>
          <li><a href="grades2.html">الصف الثاني الثانوي</a></li>
        </ul>
      </li>
      <li><a href="#" class="top-link">التواصل</a>
        <ul class="submenu">
          <li><a href="chat1.html">الصف الأول الثانوي</a></li>
          <li><a href="chat2.html">الصف الثاني الثانوي</a></li>
        </ul>
      </li>
    </ul>
  </div>

  <header class="chat-header" id="chatHeader">صفحة التواصل</header>

  <div class="container">
    <div id="messages"></div>

    <div class="input-area">
      <input type="text" id="messageInput" placeholder="اكتب رسالتك...">
      <button onclick="sendMessage()">إرسال</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, remove, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoqPEnCjtYPbWI9yYXg9eBdrPk5KvSHOg",
      authDomain: "schoolmate-d49cd.firebaseapp.com",
      databaseURL: "https://schoolmate-d49cd-default-rtdb.firebaseio.com",
      projectId: "schoolmate-d49cd",
      storageBucket: "schoolmate-d49cd.appspot.com",
      messagingSenderId: "394386208739",
      appId: "1:394386208739:web:211725ccb837298cab92d6",
      measurementId: "G-64K767NCG3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, "class2/messages"); 

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("messageInput");
    const currentUser = "معلم"; 

    window.sendMessage = function () {
      const text = input.value;
      if (text.trim() === "") return;
      push(messagesRef, { author: currentUser, text: text, timestamp: Date.now() });
      input.value = "";
    }

    input.addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); sendMessage(); } });

    function formatTime(ms) {
      const d = new Date(ms);
      return `${d.toLocaleDateString("ar-EG")} - ${d.toLocaleTimeString("ar-EG",{hour:"2-digit",minute:"2-digit"})}`;
    }

    function renderMessage(key, data) {
      let div = document.getElementById(key);
      if (!div) { div = document.createElement("div"); div.classList.add("message"); div.id = key; div.setAttribute("data-author", data.author); messagesDiv.appendChild(div); }
      div.innerHTML = `
        <span class="author">${data.author}</span>
        <span class="text">${data.text}</span>
        <span class="time">${formatTime(data.timestamp)} ${data.editedAt?`(تم التعديل: ${formatTime(data.editedAt)})`:''}</span>
      `;
      updateActions(div, data.author);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function updateActions(div, author) {
      const actions = div.querySelector(".actions"); if (actions) actions.remove();
      if (author === currentUser) {
        div.className = "message mine";
        const actionsDiv = document.createElement("div"); actionsDiv.classList.add("actions");
        actionsDiv.innerHTML = `<span onclick="editMessage('${div.id}', \`${div.querySelector(".text").innerText}\`)">✏️ تعديل</span> | <span onclick="deleteMessage('${div.id}')">🗑️ حذف</span>`;
        div.appendChild(actionsDiv);
      } else { div.className = "message other"; }
    }

    onChildAdded(messagesRef, snapshot => renderMessage(snapshot.key, snapshot.val()));
    onChildChanged(messagesRef, snapshot => renderMessage(snapshot.key, snapshot.val()));
    onChildRemoved(messagesRef, snapshot => { const div=document.getElementById(snapshot.key); if(div) div.remove(); });

    window.deleteMessage = key => remove(ref(db, "class2/messages/" + key));
    window.editMessage = (key, oldText) => { const newText = prompt("عدل رسالتك:", oldText); if(newText && newText.trim()!==""){ update(ref(db, "class2/messages/" + key), { text:newText, editedAt:Date.now() }); } }

    const roleSelect = document.getElementById('roleSelect');
    const studentMenu = document.getElementById('studentMenu');
    const teacherMenu = document.getElementById('teacherMenu');
    const savedRole = localStorage.getItem('selectedRole');
    if(savedRole){ roleSelect.value=savedRole; if(savedRole==='student'){ studentMenu.style.display='flex'; teacherMenu.style.display='none'; } else { studentMenu.style.display='none'; teacherMenu.style.display='flex'; } }
    roleSelect.addEventListener('change',()=>{ const role=roleSelect.value; localStorage.setItem('selectedRole',role); if(role==='student'){ studentMenu.style.display='flex'; teacherMenu.style.display='none'; } else{ studentMenu.style.display='none'; teacherMenu.style.display='flex'; } });

    document.querySelectorAll('#navbar .top-link').forEach(link=>{
      link.addEventListener('click',e=>{
        e.preventDefault();
        const submenu=link.nextElementSibling;
        document.querySelectorAll('.submenu').forEach(sm=>{ if(sm!==submenu) sm.classList.remove('open'); });
        submenu.classList.toggle('open');
      });
    });
    document.addEventListener('click',function(e){ if(!e.target.closest('#navbar')) document.querySelectorAll('.submenu').forEach(sm=>sm.classList.remove('open')); });
  </script>
</body>
</html>
